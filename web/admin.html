<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
        <link rel="stylesheet" type="text/css" href="style.css">
        <script id="configJs" src="js/config.js" defer></script> 

        <script>

        //Contratos
        var contrato_plataforma = "0xE788275f8A83050766741500030a475A0eB94795"; 
   
        //Se instancia el objeto web3
        var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));

        var cuentaPlataforma, instanciaPlataforma;

        async function start() {
            // Gett all the accounts
            const accounts = await web3.eth.getAccounts();

            //Cuentas
            cuentaPlataforma = accounts[0];

            //accounts[1] -> Promotor: 0x5b8BA5c293704BB759A00EBFD2C2b97A8A2DDa40
            //accounts[2] -> Inversor: 0x42A88Fb67F3b8DE7a438AB34d876b29f0d856A54

            //Recuperamos el contrato (ABI_CPII: cargado en plataformaInverABI.js)
            instanciaPlataforma = new web3.eth.Contract(ABI_CPII, contrato_plataforma);
        }

       start();

       function clearConsole() {
           document.getElementById('console').innerHTML = "";
       }
       
       function  addConsoleMessage(mensaje) {
          document.getElementById('console').innerHTML += "<br/>" + mensaje;
       }

        //Tranfiere numeroTokens a cuentaDestino (Promotor o Inversor) de la cuenta de la plataforma.
       function tranferirTokens(cuentaDestino, numeroTokens, tipoUsuario)
       {
          if (cuentaDestino == '' || numeroTokens == '' || tipoUsuario == '') {
            clearConsole();
            addConsoleMessage("Campos obligatorios: cuentaDestino, numeroTokens, tipoUsuario");
            return;
          }

          if (tipoUsuario == 'PROMOTOR') {

                addConsoleMessage("Inicio de Transferencia a Promotor: " + cuentaDestino + " de " + numeroTokens + " VAT");
                console.log("Tranfiere a promotor");
                tranferirTokensPromotor(cuentaDestino, numeroTokens);
                
                


          } else if (tipoUsuario == 'INVERSOR') {    
                 
                addConsoleMessage("Inicio de Transferencia a Inversor: " + cuentaDestino + " de " + numeroTokens + " VAT");
                console.log("Tranfiere a Inversor");     
                tranferirTokensInversor(cuentaDestino, numeroTokens);
                


          } else {
              console.log("Error: tipoUsuario no valido");
          }
                  
       }

        //Tranfiere numeroTokens a cuentaDestino (Promotor o Inversor) de la cuenta de la plataforma.
        async function tranferirTokensInversor(cuentaDestino, numeroTokens)
        {
          try {
            instanciaPlataforma.methods.transferirTokensParaInversor(cuentaDestino, numeroTokens).send( {from: cuentaPlataforma, gas: 50000}, function(error, result){
                  if(!error){
                      console.log(result);
                                            
                  } else {
                      console.error(error);
                  }
                })
          
                .on('receipt', function(receipt) {

                  if (receipt.events.TokensEmitidos) {

                    var resp = receipt.events.TokensEmitidos; 
                    addConsoleMessage("Trannsferidos tokens a Inversor: " + cuentaDestino);

                  } else {
                    addConsoleMessage("Tokens NO transferidos a Inversor. El inversor debe estar registrado previamente en la plataforma");
                  }

                });
          } catch (err) {
            console.error("Error: " + err);
            addConsoleMessage("Error realizando transferencia a Inversor: " + err);
          }
               

        }

        //Tranfiere numeroTokens a cuentaDestino de Promotor de la cuenta de la plataforma.
        async function tranferirTokensPromotor(cuentaDestino, numeroTokens)
        {
          try {      
            instanciaPlataforma.methods.transferirTokensParaPromotor(cuentaDestino, numeroTokens).send( {from: cuentaPlataforma, gas: 50000}, function(error, result){
                  if(!error){
                      console.log(result);
                                            
                  } else {
                      console.error(error);
                  }
                })
          
                .on('receipt', function(receipt) {

                  if (receipt.events.TokensEmitidos) {

                    var resp = receipt.events.TokensEmitidos; 
                    addConsoleMessage("Transferidos tokens a Promotor: " +cuentaDestino);
                  } else {
                    addConsoleMessage("Tokens NO transferidos a Promotor: El promotor debe estar registrado previamente en la plataforma");
                  }

                });
          } catch (err) {
            console.error("Error: " + err);
            addConsoleMessage("Error realizando transferencia a Promotor: " + err);
          }
        }
       			
        </script>
    </head>

    <body>

      <form name="plataformaInversion">

      <!--Plataforma  -->
      <div style="width:95%;">
         <fieldset>
            <legend>Transferencia Tokens: Exchange Test</legend>
           
            <table>
               <tr>
                  <td>
                    Tipo: 
                  </td> 
                  <td>                 
                      <select name="selectTipoUsuario">
                        <option value="PROMOTOR">Promotor</option>
                        <option value="INVERSOR">Inversor</option>
                    </select>
                  </td>

               </tr>

               <tr>
                  <td>
                    Cuenta destino: 
                  </td> 
                  <td>
                    <input type="text" name="cuentaDestino" id="cuentaDestino" size="50" maxlength="42" value="" />
                  </td>
               </tr>

               <tr>
                  <td>Tokens:</td>
                 <td>
                     <input type="number" min="1" name="numeroTokens" id="numeroTokens" size="50" maxlength="10" value=""/>
                  </td>                  
               </tr>

               <tr>
                  <td>&nbsp;</td>
                  <td>
                     <input type="button" name="tranferirTokensBtn" value="Tranferir" onclick="tranferirTokens(plataformaInversion.cuentaDestino.value,plataformaInversion.numeroTokens.value,plataformaInversion.selectTipoUsuario.value)"><br>
                  </td>             
               </tr>
            </table>
         </fieldset>
      </div> 
      <br/>
      CONSOLA:
      <div id="console" class="console-log-div"></div>

      </form>
    </body>
</html>


